app.post('/watched/:selected', (req, res)=>{
  if(req.isAuthenticated()){
    const currentMovie = req.params.selected;
    console.log("currentMovie");
    console.log(currentMovie);
    const currentMovieID = req.body.currentMovie;
    console.log(`Current Movie is: ${currentMovieID}`);

    User.findOne({_id: req.user._id}, (err, user)=>{
      if (err) {
        console.log(err);
      } else {
        Watchlist.findOneAndDelete({imdbID: currentMovieID}, (err, result)=>{
          if (!result) {
            axios.get(`https://imdb-api.com/en/API/Title/${apiKey}/${currentMovieID}`)
            .then((movieData)=>{
      
              const newMovie = new Watchlist({
                imdbID: currentMovieID,
                movieTitle: movieData.data.title,
                movieGenre: movieData.data.genres,
                movieRating: movieData.data.imDbRating,
                movieReleaseYear: movieData.data.year,
                movieLength: movieData.data.runtimeStr,
                moviePoster: movieData.data.image
              });
      
              newMovie.save()
              console.log('Save to the watchlist DB');
              res.redirect(`/watched/${currentMovie}`);
            })
            .catch((err) => console.error(err));
      
          } else{
            console.log('Does Exist and has been deleted');
            let resultID = result._id;
            console.log(resultID);
            let obj = user.wacthed.findIndex(findWatchedMovie)

            function findWatchedMovie(movie){
                // return movie._id === result._id
                // console.log("DATA");
                let movieID = JSON.stringify(movie._id);
                let resultID = JSON.stringify(result._id);

                if (movieID === resultID) {
                  console.log('They same');
                  return movieID === resultID;
                } else {
                  console.log('Not same');
                }
            }

            if(obj >= 0){

                user.watched.splice(obj, 1);
                user.save(()=>{
                  console.log('Item removed');
                })
                
            }
            res.redirect(`/watched`);
          }
        })
      }
    })
  

  } else {
    res.redirect('/login')
  }

})